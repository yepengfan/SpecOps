# Implementation Plan: Align Requirement Identifiers

**Branch**: `015-align-requirement-ids` | **Date**: 2026-02-23 | **Spec**: [spec.md](spec.md)
**Input**: Feature specification from `/specs/015-align-requirement-ids/spec.md`

## Summary

Replace all `REQ-N` / `NFR-N` requirement identifier patterns with `FR-NNN` / `NFR-NNN` (zero-padded three-digit) across AI prompt templates, evaluation rules, traceability parsing, and UI components. This is a text-replacement feature with regex updates — no new files, no schema changes, no new dependencies.

## Technical Context

**Language/Version**: TypeScript 5.x
**Primary Dependencies**: Next.js 16, React 19, Zustand 5, Dexie.js 4
**Storage**: IndexedDB via Dexie.js (no schema changes)
**Testing**: Jest (unit tests)
**Target Platform**: Web (Chrome, Firefox, Safari, Edge — last 2 versions)
**Project Type**: Web application (Next.js App Router)
**Performance Goals**: N/A (no runtime performance impact — prompt text changes only)
**Constraints**: Backward compatibility with old REQ-N format in existing project data
**Scale/Scope**: 8 source files + associated test files

## Constitution Check

*GATE: Must pass before Phase 0 research. Re-check after Phase 1 design.*

| Principle | Status | Notes |
|-----------|--------|-------|
| I. Minimal Server, Secure API Proxy | PASS | No server changes. Prompt templates are client-side strings passed to the API proxy. |
| II. Phase Gate Discipline | PASS | No phase gate logic changes. Only prompt text and parsing patterns. |
| III. Spec as Source of Truth | PASS | Spec content format changes but spec remains source of truth. |
| IV. EARS Format for Requirements | PASS | EARS format preserved — only the identifier prefix changes (REQ→FR). WHEN/THEN/SHALL/WHERE/IF keywords unchanged. |
| V. AI-Agent-Optimized Output | PASS | FR-NNN format is equally parseable by AI agents. Zero-padding improves sort consistency. |
| VI. Simplicity and YAGNI | PASS | Minimal change scope — regex pattern updates in existing files. No new abstractions. |

**Post-design re-check**: All principles still pass. No new complexity introduced.

## Project Structure

### Documentation (this feature)

```text
specs/015-align-requirement-ids/
├── spec.md
├── plan.md
├── research.md
├── data-model.md
├── quickstart.md
├── checklists/
│   └── requirements.md
└── tasks.md              # Generated by /speckit.tasks
```

### Source Code (files modified)

```text
lib/
├── prompts/
│   ├── spec.ts            # FR-NNN format in generation + regeneration prompts
│   ├── plan.ts            # FR-NNN in traceability comment instructions
│   ├── tasks.ts           # FR-NNN in reference instructions + traceability
│   └── traceability.ts    # fr-NNN in reanalyze prompt
├── eval/
│   └── rules.ts           # FR/NFR regex patterns, error messages
└── db/
    └── traceability.ts    # parseRequirementIds() regex, ID/label format

components/
└── traceability/
    ├── matrix-table.tsx   # Empty-state guidance message
    └── cell-detail.tsx    # Requirement content extraction regex

__tests__/
└── unit/
    ├── eval-rules.test.ts       # Updated test fixtures
    ├── spec-parser.test.ts      # Updated test fixtures
    └── traceability.test.ts     # Updated test fixtures + expected IDs
```

**Structure Decision**: Existing Next.js project structure. All changes are modifications to existing files — no new source files created.

## Key Design Decisions

### 1. Regex Pattern Changes

All regex patterns that match `REQ-\d+` are updated to match `FR-\d+` (and handle both formats for backward compat where needed).

**Spec generation prompt** (`lib/prompts/spec.ts`):
- `**REQ-<number>**:` → `**FR-<number>**:` in prompt instructions and examples
- `**NFR-<number>**:` → `**NFR-<number>**:` (prefix unchanged, but examples updated to show zero-padded numbers like `NFR-001`)

**Evaluation rules** (`lib/eval/rules.ts`):
- Line filter regex: `(REQ|NFR)-\d+` → `(FR|NFR)-\d+`
- EARS check filter: `\*\*REQ-` → `\*\*FR-`
- Error messages: `REQ-N` → `FR-NNN`

**Traceability parsing** (`lib/db/traceability.ts`):
- Bold regex: `\*\*REQ-(\d+)\*\*:` → `\*\*(FR|REQ)-(\d+)\*\*:` (dual match for backward compat)
- Heading regex: `## Req (\d+):` → `## (FR-\d+|Req \d+):` (dual match)
- ID construction: `req-${num}` → `fr-${num.padStart(3, '0')}` (zero-padded)
- Label construction: `REQ-${num}:` → `FR-${num.padStart(3, '0')}:`

**Cell detail dialog** (`components/traceability/cell-detail.tsx`):
- Regex extracts `FR-NNN` format; falls back to `REQ-N` for old content
- ID prefix check: `req-` → supports both `fr-` and `req-` prefixes

**Traceability prompts** (`lib/prompts/traceability.ts`, `lib/prompts/plan.ts`, `lib/prompts/tasks.ts`):
- All `req-N` references → `fr-NNN`
- All `REQ-N` references → `FR-NNN`

### 2. Backward Compatibility Strategy

Parsing functions (`parseRequirementIds`, `cell-detail.tsx`, `evaluateSpec`) accept **both** old and new formats:
- Primary match: `**FR-NNN**:` / `**NFR-NNN**:`
- Fallback match: `**REQ-N**:` (for existing data)

When the old format is matched, IDs are **normalized** to the new format:
- `REQ-1` → internal ID `fr-001`, label `FR-001: ...`

This ensures existing projects continue to work without regeneration.

### 3. Zero-Padding in Prompts

The AI prompt examples show zero-padded numbers (`FR-001`, `FR-002`) to guide the LLM. The parsing regex uses `\d+` (not `\d{3}`) to be tolerant of LLM output that may omit padding. The normalization step applies padding regardless.

## File Change Summary

| File | Change Type | Scope |
|------|-------------|-------|
| `lib/prompts/spec.ts` | Modify | 2 functions: prompt text REQ→FR, examples with zero-padding |
| `lib/prompts/plan.ts` | Modify | 1 function: traceability comment format, ID derivation example |
| `lib/prompts/tasks.ts` | Modify | 1 function: reference format, traceability comment |
| `lib/prompts/traceability.ts` | Modify | 1 function: requirement ID format in reanalyze prompt |
| `lib/eval/rules.ts` | Modify | 1 function (`evaluateSpec`): regex patterns, error messages |
| `lib/db/traceability.ts` | Modify | 1 function (`parseRequirementIds`): regex, ID/label construction |
| `components/traceability/matrix-table.tsx` | Modify | 1 line: guidance message text |
| `components/traceability/cell-detail.tsx` | Modify | ~10 lines: regex patterns, ID prefix handling |
| `__tests__/unit/eval-rules.test.ts` | Modify | Test fixtures: REQ-N → FR-NNN |
| `__tests__/unit/spec-parser.test.ts` | Modify | Test fixtures: REQ-N → FR-NNN |
| `__tests__/unit/traceability.test.ts` | Modify | Test fixtures + expected output |
